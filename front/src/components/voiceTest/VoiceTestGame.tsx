import React, { useEffect, useRef, useState } from 'react';
import GameExitModal from './GameExitModal';
import GameStartModal from './GameStartModal';
import GamePauseModal from './GamePauseModal';
import VoiceTestSelection from './VoiceTestSelection';
import ExistingRecordingSelection from './ExistingRecordingSelection';
import VoiceRangeResultModal from './VoiceRangeResultModal';
import type { Recording } from '../../types/recording';

// ÏõêÎ≥∏ PitchCraft Í≤åÏûÑÏùÑ Í∑∏ÎåÄÎ°ú Í∞ÄÏ†∏ÏôÄÏÑú ÌÜµÌï©
const VoiceTestGame: React.FC = () => {
    const gameRef = useRef<HTMLDivElement>(null);
    const [isGameLoaded, setIsGameLoaded] = useState(false);
    const gameInstanceRef = useRef<any>(null);
    const [showStartModal, setShowStartModal] = useState(true);
    const [showExitModal, setShowExitModal] = useState(false);
    const [showPauseModal, setShowPauseModal] = useState(false);
    const [showVoiceTestSelection, setShowVoiceTestSelection] = useState(false);
    const [showExistingRecordingSelection, setShowExistingRecordingSelection] = useState(false);
    const [isGamePaused, setIsGamePaused] = useState(false);
    const [showVoiceRangeResult, setShowVoiceRangeResult] = useState(false);
    const [gameOverProcessed, setGameOverProcessed] = useState(false);
    const [voiceRangeData, setVoiceRangeData] = useState<{
        highestNote?: string;
        lowestNote?: string;
        highestFrequency?: number;
        lowestFrequency?: number;
    }>({});

    const loadGameWithEventListeners = () => {
        if (!gameRef.current) return;
        
        console.log('üéÆ Í≤åÏûÑ Î°úÎìú Î∞è Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏãúÏûë');
        
        // Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑàÏóê ID ÏÑ§Ï†ï (ÏõêÎ≥∏ Í≤åÏûÑÏù¥ Ï∞æÎäî ID)
        gameRef.current.id = 'game';
        
        // Í≤åÏûÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Î®ºÏ†Ä ÏÑ§Ï†ï
        setupGameEventListeners();
        
        // Í≤åÏûÑ bundle.js Î°úÎìú
        const gameScript = document.createElement('script');
        gameScript.src = '/bundle.js';
        gameScript.onload = () => {
            console.log('üéÆ Í≤åÏûÑ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú ÏôÑÎ£å');
            setIsGameLoaded(true);
            gameInstanceRef.current = true;
            
            console.log('üéÆ Í≤åÏûÑ Î°úÎìú ÏôÑÎ£å, Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ïÎê®');
        };
        gameScript.onerror = () => {
            console.error('Í≤åÏûÑ Î°úÎìú Ïã§Ìå®');
        };

        gameRef.current.appendChild(gameScript);
    };

    const setupGameEventListeners = () => {
        console.log('üéÆ Í≤åÏûÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏãúÏûë');
        
        // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
        if ((window as any).gameOverHandler) {
            window.removeEventListener('gameOver', (window as any).gameOverHandler);
            document.removeEventListener('gameOver', (window as any).gameOverHandler);
        }
        
        // Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        const handleNextTestEvent = () => {
            console.log('üéÆ Îã§Ïùå ÌÖåÏä§Ìä∏ Î∞õÍ∏∞ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ');
            handleNextTest();
        };
        
        const handleRestartEvent = () => {
            console.log('üéÆ Îã§ÏãúÌïòÍ∏∞ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ');
            // Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            setGameOverProcessed(false);
            setShowVoiceRangeResult(false);
            setVoiceRangeData({});
            handleRestart();
        };
        
        const handleExitEvent = () => {
            console.log('üéÆ Í∑∏ÎßåÌïòÍ∏∞ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ');
            handleExit();
        };
        
        const handleGameOverEvent = (event: CustomEvent) => {
            console.log('üéÆ ===== Í≤åÏûÑ Ïò§Î≤Ñ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ ÏãúÏûë =====');
            console.log('üéÆ Ïù¥Î≤§Ìä∏ ÏÉÅÏÑ∏:', event.detail);
            console.log('üéÆ Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖ:', event.type);
            console.log('üéÆ ÌòÑÏû¨ ÏÉÅÌÉú:', { gameOverProcessed, showVoiceRangeResult });
            console.log('üéÆ Ï†ÑÏó≠ Î≥ÄÏàò:', { 
                isGameOver: (window as any).isGameOver,
                gameState: (window as any).gameState 
            });
            console.log('üéÆ React ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë');
            
            // Ïù¥ÎØ∏ Í≤åÏûÑ Ïò§Î≤Ñ Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏúºÎ©¥ Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ
            if (gameOverProcessed || showVoiceRangeResult) {
                console.log('üéÆ Ïù¥ÎØ∏ Í≤åÏûÑ Ïò§Î≤Ñ Ï≤òÎ¶¨Í∞Ä ÏôÑÎ£åÎê® - Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ');
                return;
            }
            
            // Í≤åÏûÑ Ïò§Î≤Ñ Ï≤òÎ¶¨ ÏãúÏûë
            setGameOverProcessed(true);
            
            // Í≤åÏûÑ ÏôÑÏ†Ñ Ï†ïÏßÄ Î∞è Ï†ïÎ¶¨
            if ((window as any).game) {
                console.log('üéÆ Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÏßÄ Î∞è Ï†ïÎ¶¨');
                (window as any).game.paused = true;
                (window as any).game.time.events.pause();
                (window as any).game.world.setBounds(0, 0, 0, 0); // ÏõîÎìú Í≤ΩÍ≥Ñ Ï†úÍ±∞
            }
            
            // Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú ÏÑ§Ï†ï
            (window as any).isGameOver = true;
            (window as any).gameState = { gameOver: true };
            
            // ÏùåÏó≠ÎåÄ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú (Í≤åÏûÑÏóêÏÑú Ï†ÑÎã¨Îêú Îç∞Ïù¥ÌÑ∞)
            const gameData = event.detail || {};
            const pitchScores = gameData.pitchScores || {};
            
            console.log('üéÆ ÏùåÏó≠ÎåÄ Ï†êÏàò Îç∞Ïù¥ÌÑ∞:', pitchScores);
            
            // ÏùåÏó≠ÎåÄ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
            const frequencies = Object.keys(pitchScores).map(note => {
                // ÏùåÌëúÎ•º Ï£ºÌååÏàòÎ°ú Î≥ÄÌôòÌïòÎäî Í∞ÑÎã®Ìïú Îß§Ìïë
                const noteToFreq: { [key: string]: number } = {
                    'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31, 'F#2': 92.50,
                    'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
                    'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00,
                    'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
                    'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99,
                    'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
                    'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99,
                    'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
                    'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'E6': 1318.51, 'F6': 1396.91, 'F#6': 1479.98,
                    'G6': 1567.98, 'G#6': 1661.22, 'A6': 1760.00
                };
                return { note, frequency: noteToFreq[note] || 0, score: pitchScores[note] };
            }).filter(item => item.frequency > 0);
            
            console.log('üéÆ Í≥ÑÏÇ∞Îêú Ï£ºÌååÏàò Îç∞Ïù¥ÌÑ∞:', frequencies);
            
            if (frequencies.length > 0) {
                const sortedFrequencies = frequencies.sort((a, b) => a.frequency - b.frequency);
                const lowest = sortedFrequencies[0];
                const highest = sortedFrequencies[sortedFrequencies.length - 1];
                
                console.log('üéÆ ÏµúÏ†Ä/ÏµúÍ≥† ÏùåÏó≠ÎåÄ:', { lowest, highest });
                
                setVoiceRangeData({
                    highestNote: highest.note,
                    lowestNote: lowest.note,
                    highestFrequency: highest.frequency,
                    lowestFrequency: lowest.frequency,
                });
            } else {
                // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                console.log('üéÆ ÏùåÏó≠ÎåÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏñ¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©');
                setVoiceRangeData({
                    highestNote: 'C5',
                    lowestNote: 'C3',
                    highestFrequency: 523.25,
                    lowestFrequency: 130.81,
                });
            }
            
            // ÏùåÏó≠ÎåÄ Í≤∞Í≥º Î™®Îã¨ ÌëúÏãú
            console.log('üéÆ ÏùåÏó≠ÎåÄ Í≤∞Í≥º Î™®Îã¨ ÌëúÏãú ÏãúÏûë');
            console.log('üéÆ setShowVoiceRangeResult(true) Ìò∏Ï∂ú');
            setShowVoiceRangeResult(true);
            console.log('üéÆ ===== Í≤åÏûÑ Ïò§Î≤Ñ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ ÏôÑÎ£å =====');
        };
        
        // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ìï∏Îì§Îü¨ Ï†ÄÏû• (Ï§ëÎ≥µ Î∞©ÏßÄÏö©)
        (window as any).gameOverHandler = handleGameOverEvent;
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        window.addEventListener('gameOver', handleGameOverEvent as EventListener);
        window.addEventListener('nextTest', handleNextTestEvent);
        window.addEventListener('restartGame', handleRestartEvent);
        window.addEventListener('exitGame', handleExitEvent);
        
        // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù (GameOver.tsÏóêÏÑú Ìò∏Ï∂úÌï† Ïàò ÏûàÎèÑÎ°ù)
        (window as any).onGameOver = handleGameOverEvent;
        
        console.log('üéÆ Í≤åÏûÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å');
        console.log('üéÆ Îì±Î°ùÎêú Ï†ÑÏó≠ Ìï®Ïàò:', !!(window as any).onGameOver);
        console.log('üéÆ Îì±Î°ùÎêú Ìï∏Îì§Îü¨:', !!(window as any).gameOverHandler);
        
        // Ï†ÑÏó≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎèÑ Ï∂îÍ∞Ä (ÌôïÏã§ÌïòÍ≤å)
        document.addEventListener('gameOver', handleGameOverEvent as EventListener);
        document.addEventListener('nextTest', handleNextTestEvent);
        document.addEventListener('restartGame', handleRestartEvent);
        document.addEventListener('exitGame', handleExitEvent);
        
        // Ï†ïÎ¶¨ Ìï®Ïàò Î∞òÌôò
        return () => {
            console.log('üéÆ Í≤åÏûÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨');
            window.removeEventListener('gameOver', handleGameOverEvent as EventListener);
            window.removeEventListener('nextTest', handleNextTestEvent);
            window.removeEventListener('restartGame', handleRestartEvent);
            window.removeEventListener('exitGame', handleExitEvent);
            
            document.removeEventListener('gameOver', handleGameOverEvent as EventListener);
            document.removeEventListener('nextTest', handleNextTestEvent);
            document.removeEventListener('restartGame', handleRestartEvent);
            document.removeEventListener('exitGame', handleExitEvent);
            
            // Ï†ÑÏó≠ Ìï®Ïàò Ï†úÍ±∞
            (window as any).onGameOver = null;
            (window as any).gameOverHandler = null;
        };
    };
    


    useEffect(() => {
        // Ï†ÑÏó≠ Í≤åÏûÑ Ïò§Î≤Ñ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (ÌôïÏã§ÌïòÍ≤å)
        const globalGameOverHandler = (event: CustomEvent) => {
            console.log('üéÆ Ï†ÑÏó≠ Í≤åÏûÑ Ïò§Î≤Ñ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ:', event.detail);
            setShowVoiceTestSelection(true);
        };
        
        window.addEventListener('gameOver', globalGameOverHandler as EventListener);
        document.addEventListener('gameOver', globalGameOverHandler as EventListener);
        
        // Í≤åÏûÑ ÏãúÏûë Î™®Îã¨Ïù¥ Ïó¥Î†§ÏûàÏùÑ ÎïåÎäî Í≤åÏûÑÏùÑ Î°úÎìúÌïòÏßÄ ÏïäÏùå
        if (showStartModal) {
            return () => {
                window.removeEventListener('gameOver', globalGameOverHandler as EventListener);
                document.removeEventListener('gameOver', globalGameOverHandler as EventListener);
            };
        }

        if (!gameRef.current) return;

        // Ïù¥ÎØ∏ Í≤åÏûÑÏù¥ Î°úÎìúÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if (gameInstanceRef.current) {
            return () => {
                window.removeEventListener('gameOver', globalGameOverHandler as EventListener);
                document.removeEventListener('gameOver', globalGameOverHandler as EventListener);
            };
        }

        // ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (ÏõêÎ≥∏ Í≤åÏûÑÍ≥º ÎèôÏùº)
        (window as any).process = {
            env: {
                WIDTH: 1080,
                HEIGHT: 768,
                NODE_ENV: 'production'
            }
        };

        // Í∏∞Ï°¥ Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Ï†ïÎ¶¨
        const existingGame = document.getElementById('game');
        if (existingGame) {
            existingGame.innerHTML = '';
        }

        // Í∏∞Ï°¥ Phaser Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨
        if ((window as any).game) {
            try {
                (window as any).game.destroy();
    } catch (e) {
                console.log('Í∏∞Ï°¥ Í≤åÏûÑ Ï†ïÎ¶¨ Ï§ë Ïò§Î•ò:', e);
            }
        }

        // PhaserÍ∞Ä Ïù¥ÎØ∏ Î°úÎìúÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if ((window as any).Phaser) {
            loadGameWithEventListeners();
        } else {
            // Phaser ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î®ºÏ†Ä Î°úÎìú (Î°úÏª¨ÏóêÏÑú)
            const phaserScript = document.createElement('script');
            phaserScript.src = '/assets/js/phaser.min.js';
            
            phaserScript.onload = () => {
                loadGameWithEventListeners();
            };
            
            phaserScript.onerror = () => {
                console.error('Phaser Î°úÎìú Ïã§Ìå®');
            };

            document.head.appendChild(phaserScript);
        }


        return () => {
            console.log('üéÆ VoiceTestGame cleanup ÏãúÏûë');
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            const cleanup = setupGameEventListeners();
            if (cleanup) {
                cleanup();
            }
            
            // Ï†ÑÏó≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†ïÎ¶¨
            const globalGameOverHandler = (event: CustomEvent) => {
                console.log('üéÆ Ï†ÑÏó≠ Í≤åÏûÑ Ïò§Î≤Ñ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ:', event.detail);
                setShowVoiceTestSelection(true);
            };
            window.removeEventListener('gameOver', globalGameOverHandler as EventListener);
            document.removeEventListener('gameOver', globalGameOverHandler as EventListener);
            
            // Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨
            gameInstanceRef.current = null;
            setIsGameLoaded(false);
            
            // Í∏∞Ï°¥ Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨
            if ((window as any).game) {
                try {
                    (window as any).game.destroy();
                    (window as any).game = null;
                } catch (e) {
                    console.log('Í≤åÏûÑ Ï†ïÎ¶¨ Ï§ë Ïò§Î•ò:', e);
                }
            }
            
            // Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
            if (gameRef.current) {
                gameRef.current.innerHTML = '';
            }
            
            console.log('üéÆ VoiceTestGame cleanup ÏôÑÎ£å');
        };
    }, [showStartModal]);

    // Î™®Îã¨ Ìï∏Îì§Îü¨Îì§
    const handleStartGame = () => {
        console.log('üéÆ Í≤åÏûÑ ÏãúÏûë');
        setShowStartModal(false);
        // Í≤åÏûÑ ÏãúÏûë Ïãú Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú Î¶¨ÏÖã
        (window as any).isGameOver = false;
        (window as any).gameState = null;
        
        // Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        setGameOverProcessed(false);
        setShowVoiceRangeResult(false);
        setVoiceRangeData({});
        
        console.log('üéÆ Í≤åÏûÑ ÏãúÏûë ÏôÑÎ£å');
    };

    const handlePause = () => {
        setIsGamePaused(true);
        setShowPauseModal(true);
        // Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ (Phaser Í≤åÏûÑÏù¥ ÏûàÎã§Î©¥)
        if ((window as any).game && (window as any).game.paused !== undefined) {
            (window as any).game.paused = true;
        }
    };

    const handleResume = () => {
        setIsGamePaused(false);
        setShowPauseModal(false);
        // Í≤åÏûÑ Ïû¨Í∞ú (Phaser Í≤åÏûÑÏù¥ ÏûàÎã§Î©¥)
        if ((window as any).game && (window as any).game.paused !== undefined) {
            (window as any).game.paused = false;
        }
    };

    const handleRestart = () => {
        // Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨
        if (gameRef.current) {
            gameRef.current.innerHTML = '';
        }
        
        // Í∏∞Ï°¥ Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨
        if ((window as any).game) {
            try {
                (window as any).game.destroy();
            } catch (e) {
                console.log('Í≤åÏûÑ Ï†ïÎ¶¨ Ï§ë Ïò§Î•ò:', e);
            }
        }
        
        // Í≤åÏûÑ Ïû¨ÏãúÏûë
        gameInstanceRef.current = null;
        setIsGameLoaded(false);
        
        // Ïû†Ïãú ÌõÑ Í≤åÏûÑ Îã§Ïãú Î°úÎìú
        setTimeout(() => {
            if (gameRef.current) {
                loadGameWithEventListeners();
            }
        }, 100);
    };

    const handleNextTest = () => {
        console.log('üéÆ Îã§Ïùå ÌÖåÏä§Ìä∏ Î∞õÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠');
        setShowVoiceTestSelection(true);
    };

    const handleVoiceRangeResultClose = () => {
        setShowVoiceRangeResult(false);
        // Í≤åÏûÑ Ïû¨ÏãúÏûë
        handleRestart();
    };

    const handleVoiceRangeResultContinue = () => {
        setShowVoiceRangeResult(false);
        // ÏùåÏó≠ÎåÄ ÌÖåÏä§Ìä∏ ÏôÑÎ£å ÌõÑ ÏÑ†ÌÉù ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        setShowVoiceTestSelection(true);
    };


    const handleBackToGame = () => {
        setShowVoiceTestSelection(false);
        setShowExistingRecordingSelection(false);
    };


    const handleGetRecommendations = () => {
        console.log('üéµ VoiceTestGame: Ï∂îÏ≤úÎ∞õÍ∏∞ Ìï®Ïàò Ìò∏Ï∂úÎê®');
        setShowVoiceTestSelection(false);
        setShowExistingRecordingSelection(true);
    };

    const handleStartVoiceTest = () => {
        console.log('üéµ VoiceTestGame: ÏùåÏó≠ÎåÄ ÌÖåÏä§Ìä∏ ÏãúÏûë Ìï®Ïàò Ìò∏Ï∂úÎê®');
        setShowVoiceTestSelection(false);
        // Í≤åÏûÑ ÏãúÏûë Î™®Îã¨ ÌëúÏãú
        setShowStartModal(true);
    };

    const handleSelectExistingRecording = (recording: Recording, uploadId?: number) => {
        console.log('Í∏∞Ï°¥ ÎÖπÏùåÎ≥∏ ÏÑ†ÌÉù:', recording, uploadId);
        setShowExistingRecordingSelection(false);
        // Í∏∞Ï°¥ ÎÖπÏùåÎ≥∏ÏúºÎ°ú Î∞îÎ°ú Ï∂îÏ≤ú ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        window.location.href = '/recommendations';
    };

    const handleBackFromExistingSelection = () => {
        setShowExistingRecordingSelection(false);
        setShowVoiceTestSelection(true);
    };

    const handleExit = () => {
        setShowExitModal(false);
        // Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        window.location.href = '/';
    };

    const handleExitConfirm = () => {
        setShowExitModal(false);
        handleExit();
    };

    const handleExitCancel = () => {
        setShowExitModal(false);
    };

  // Í∏∞Ï°¥ ÎÖπÏùåÎ≥∏ ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú
  if (showExistingRecordingSelection) {
    return (
      <ExistingRecordingSelection
        onSelectRecording={handleSelectExistingRecording}
        onBack={handleBackFromExistingSelection}
      />
    );
  }

  // ÏùåÏÑ± ÌÖåÏä§Ìä∏ ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú
  if (showVoiceTestSelection) {
    return (
      <VoiceTestSelection
        onGetRecommendations={handleGetRecommendations}
        onStartVoiceTest={handleStartVoiceTest}
        onBack={handleBackToGame}
      />
    );
  }


  return (
        <>
            <style>
                {`
                    /* ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨ Ïï†ÎãàÎ©îÏù¥ÏÖò */
                    @keyframes cyberGlow {
                        0% { opacity: 0.3; }
                        100% { opacity: 0.7; }
                    }
                    
                    @keyframes gridMove {
                        0% { transform: translate(0, 0); }
                        100% { transform: translate(50px, 50px); }
                    }
                    
                    @keyframes neonPulse {
                        0%, 100% { 
                            text-shadow: 0 0 5px #00ff88, 0 0 10px #00ff88, 0 0 15px #00ff88;
                        }
                        50% { 
                            text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, 0 0 30px #00ff88;
                        }
                    }
                    
                    @keyframes coinSlotGlow {
                        0%, 100% { 
                            opacity: 0.5;
                            transform: translateY(-50%) scaleX(1);
                        }
                        50% { 
                            opacity: 1;
                            transform: translateY(-50%) scaleX(1.2);
                        }
                    }
                    
                    @keyframes coinPulse {
                        0%, 100% { 
                            transform: scale(1);
                            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
                        }
                        50% { 
                            transform: scale(1.2);
                            box-shadow: 0 0 20px rgba(0, 255, 136, 1);
                        }
                    }
                    
                    @keyframes micPulse {
                        0%, 100% { 
                            transform: scale(1);
                            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
                        }
                        50% { 
                            transform: scale(1.05);
                            box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
                        }
                    }
                    
                    /* Í≤åÏûÑ Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎì§ Ï°∞Ï†ï - ÏûòÎ¶º Î∞©ÏßÄ */
                    #game canvas {
                        width: 100% !important;
                        height: 100% !important;
                        object-fit: contain !important;
                    }
                    
                    /* Í≤åÏûÑ ÎÇ¥ Î™®Îì† Ïù¥ÎØ∏ÏßÄÎì§ - ÏûòÎ¶º Î∞©ÏßÄ */
                    #game img,
                    #game canvas img,
                    #game * img,
                    #game div[style*="background"],
                    #game *[style*="background"] {
                        width: 100% !important;
                        height: 100% !important;
                        object-fit: contain !important;
                        object-position: center !important;
                    }
                    
                    /* Í≤åÏûÑ ÌôîÎ©¥ Ï†ïÎ¶¨ - ÍπîÎÅîÌïú Î†àÏù¥ÏïÑÏõÉ */
                    #game {
                        position: relative !important;
                        overflow: hidden !important;
                        width: 100% !important;
                        height: 100% !important;
                    }
                    
                    /* Í≤åÏûÑ ÎÇ¥Î∂Ä Î™®Îì† ÏöîÏÜåÎì§ */
                    #game * {
                        transform-origin: center center !important;
                    }
                    
                    /* Phaser Í≤åÏûÑ Ïä§ÌîÑÎùºÏù¥Ìä∏Îì§ */
                    #game canvas + * {
                        transform: scale(1.0) !important;
                    }
                    
                    /* Í≤åÏûÑ Î∞∞Í≤Ω Î†àÏù¥Ïñ¥Îì§ */
                    #game div[style*="position: absolute"],
                    #game div[style*="position:fixed"] {
                        width: 100% !important;
                        height: 100% !important;
                    }
                    
                    /* Í≤åÏûÑ ÎÇ¥ Î™®Îì† div ÏöîÏÜåÎì§ */
                    #game div {
                        background-size: 100% 100% !important;
                        background-position: center !important;
                    }
                `}
            </style>
            <div style={{ 
                width: '100vw',
                height: '100vh',
                background: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                position: 'relative',
                overflow: 'hidden'
            }}>
                {/* ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨ Î∞∞Í≤Ω Ìö®Í≥º */}
                <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: '100%',
                    background: `
                        radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 0, 68, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(0, 255, 255, 0.05) 0%, transparent 50%)
                    `,
                    animation: 'cyberGlow 4s ease-in-out infinite alternate'
                }} />

                {/* ÎÑ§Ïò® Í∑∏Î¶¨Îìú Î∞∞Í≤Ω */}
                <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: '100%',
                    backgroundImage: `
                        linear-gradient(rgba(0, 255, 136, 0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 136, 0.1) 1px, transparent 1px)
                    `,
                    backgroundSize: '50px 50px',
                    animation: 'gridMove 20s linear infinite'
                }} />

                {/* Î†àÌä∏Î°ú Í≤åÏûÑÍ∏∞ Î™®ÏñëÏùò Î™®Îã¨ */}
                <div style={{
                    width: '900px',
                    height: '650px',
                    background: 'linear-gradient(145deg, #1a1a1a, #0a0a0a)',
                    borderRadius: '25px',
                    boxShadow: '0 0 40px rgba(0, 255, 136, 0.3), inset 0 0 40px rgba(0, 255, 136, 0.05)',
                    border: '3px solid #00ff88',
                    position: 'relative',
                    overflow: 'hidden',
                    display: 'flex',
                    flexDirection: 'column',
                    backdropFilter: 'blur(5px)',
                    // Î†àÌä∏Î°ú Í≤åÏûÑÍ∏∞ ÎäêÎÇåÏùÑ ÏúÑÌïú Ï∂îÍ∞Ä Ïä§ÌÉÄÏùº
                    transform: 'perspective(800px) rotateX(3deg)',
                    transformStyle: 'preserve-3d'
                }}>
                    {/* ÏÉÅÎã® Ìå®ÎÑê */}
                    <div style={{
                        height: '60px',
                        background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                        borderTopLeftRadius: '22px',
                        borderTopRightRadius: '22px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '0 25px',
                        borderBottom: '2px solid #00ff88',
                        boxShadow: '0 2px 10px rgba(0, 255, 136, 0.2)',
                        position: 'relative'
                    }}>
                        {/* ÏΩîÏù∏ Ïä¨Î°Ø */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '50px',
                                height: '30px',
                                background: 'linear-gradient(145deg, #0a0a0a, #000000)',
                                borderRadius: '15px',
                                border: '2px solid #00ff88',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                boxShadow: 'inset 0 0 8px rgba(0, 0, 0, 0.9)'
                            }}>
                                <div style={{
                                    width: '40px',
                                    height: '20px',
                                    background: 'linear-gradient(90deg, #222, #444, #222)',
                                    borderRadius: '10px',
                                    border: '1px solid #555',
                                    position: 'relative',
                                    overflow: 'hidden'
                                }}>
                                    <div style={{
                                        position: 'absolute',
                                        top: '50%',
                                        left: '8px',
                                        transform: 'translateY(-50%)',
                                        width: '24px',
                                        height: '1px',
                                        background: 'linear-gradient(90deg, #00ff88, #00ffff)',
                                        borderRadius: '1px',
                                        animation: 'coinSlotGlow 2s ease-in-out infinite'
                                    }} />
                                </div>
                                <div style={{
                                    position: 'absolute',
                                    top: '-3px',
                                    right: '-3px',
                                    width: '10px',
                                    height: '10px',
                                    background: 'radial-gradient(circle, #00ff88, #00aa55)',
                                    borderRadius: '50%',
                                    boxShadow: '0 0 8px rgba(0, 255, 136, 0.8)',
                                    animation: 'coinPulse 1.5s ease-in-out infinite'
                                }} />
                            </div>
                        </div>
                        {/* ÎßàÏù¥ÌÅ¨ Î∂ÄÎ∂Ñ */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                background: 'linear-gradient(145deg, #0a0a0a, #000000)',
                                borderRadius: '50%',
                                border: '2px solid #00ff88',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                boxShadow: '0 0 15px rgba(0, 255, 136, 0.4)',
                                animation: 'micPulse 2s ease-in-out infinite'
                            }}>
                                <div style={{
                                    width: '16px',
                                    height: '16px',
                                    background: 'radial-gradient(circle, #00ff88, #00aa55)',
                                    borderRadius: '50%',
                                    position: 'relative'
                                }}>
                                    <div style={{
                                        position: 'absolute',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        width: '6px',
                                        height: '6px',
                                        background: '#ffffff',
                                        borderRadius: '50%',
                                        boxShadow: '0 0 3px rgba(255, 255, 255, 0.8)'
                                    }} />
                                </div>
                                {/* ÎßàÏù¥ÌÅ¨ Í∑∏Î¶¨Îìú Ìå®ÌÑ¥ */}
                                <div style={{
                                    position: 'absolute',
                                    top: '3px',
                                    left: '3px',
                                    right: '3px',
                                    bottom: '3px',
                                    background: `
                                        radial-gradient(circle at 30% 30%, rgba(0, 255, 136, 0.2) 1px, transparent 1px),
                                        radial-gradient(circle at 70% 70%, rgba(0, 255, 136, 0.2) 1px, transparent 1px)
                                    `,
                                    backgroundSize: '6px 6px',
                                    borderRadius: '50%',
                                    pointerEvents: 'none'
                                }} />
                            </div>
                        </div>
                        
                        {/* Ï†úÎ™© */}
                        <div style={{
                            color: '#00ff88',
                            fontSize: '20px',
                            fontWeight: 'bold',
                            textShadow: '0 0 10px rgba(0, 255, 136, 0.8)',
                            background: 'linear-gradient(45deg, #00ff88, #00ffff)',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            letterSpacing: '1px'
                        }}>
                            PITCHCRAFT
                        </div>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px'
                        }}>
                            {isGameLoaded && !isGamePaused && (
                                <>
                                    <button
                                        onClick={handlePause}
                                        style={{
                                            background: 'linear-gradient(45deg, #ff9800, #f57c00)',
                                            color: '#ffffff',
                                            border: '2px solid #ff9800',
                                            padding: '8px 16px',
                                            borderRadius: '20px',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            transition: 'all 0.3s ease',
                                            boxShadow: '0 0 15px rgba(255, 152, 0, 0.5)',
                                            marginRight: '10px'
                                        }}
                                        onMouseOver={(e) => {
                                            e.currentTarget.style.transform = 'translateY(-2px)';
                                            e.currentTarget.style.boxShadow = '0 4px 12px rgba(255, 152, 0, 0.4)';
                                        }}
                                        onMouseOut={(e) => {
                                            e.currentTarget.style.transform = 'translateY(0)';
                                            e.currentTarget.style.boxShadow = '0 2px 8px rgba(255, 152, 0, 0.3)';
                                        }}
                                    >
                                        ‚è∏Ô∏è PAUSE
                                    </button>
                                    
                                </>
                            )}
            </div>
          </div>

                    {/* Í≤åÏûÑ ÌôîÎ©¥ ÏòÅÏó≠ */}
                    <div style={{
                        flex: 1,
                        background: '#000000',
                        position: 'relative',
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        overflow: 'hidden',
                        margin: '0 20px'
                    }}>
                        <div 
                            ref={gameRef} 
                            style={{
                                width: '900px', 
                                height: '600px',
                                display: 'flex',
                                justifyContent: 'center',
                                alignItems: 'center',
                                position: 'relative',
                                overflow: 'hidden',
                                background: '#000000',
                                pointerEvents: showVoiceRangeResult ? 'none' : 'auto', // Î™®Îã¨Ïù¥ ÌëúÏãúÎêòÎ©¥ ÌÅ¥Î¶≠ Î¨¥Ïãú
                            }}
                            onClick={(e) => {
                                // Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉúÏóêÏÑúÎäî ÌÅ¥Î¶≠ Î¨¥Ïãú
                                if (showVoiceRangeResult || gameOverProcessed) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    console.log('üéÆ Í≤åÏûÑ Ïò§Î≤Ñ ÏÉÅÌÉú - ÌÅ¥Î¶≠ Î¨¥Ïãú');
                                    return;
                                }
                            }}
                        />
                        
                        {!isGameLoaded && (
                            <div style={{
                                position: 'absolute',
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                color: '#ffffff',
                                fontSize: '18px',
                                textAlign: 'center',
                                zIndex: 2
                            }}>
                                Í≤åÏûÑÏùÑ Î°úÎî© Ï§ëÏûÖÎãàÎã§...
            </div>
          )}
        </div>

                    {/* Í≤åÏûÑÍ∏∞ ÌïòÎã® Î∂ÄÎ∂Ñ - Ï°∞Ïù¥Ïä§Ìã±Í≥º Î≤ÑÌäºÎì§ */}
                    <div style={{
                        height: '60px',
                        background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                        borderBottomLeftRadius: '22px',
                        borderBottomRightRadius: '22px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between',
                        padding: '0 25px',
                        borderTop: '2px solid #00ff88',
                        flexShrink: 0,
                        boxShadow: '0 -2px 10px rgba(0, 255, 136, 0.2)',
                        position: 'relative'
                    }}>
                        {/* Ï°∞Ïù¥Ïä§Ìã± */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '15px'
                        }}>
                            <div style={{
                                width: '50px',
                                height: '50px',
                                background: 'linear-gradient(145deg, #0a0a0a, #000000)',
                                borderRadius: '50%',
                                border: '3px solid #00ff88',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative',
                                boxShadow: '0 0 15px rgba(0, 255, 136, 0.3)'
                            }}>
                                <div style={{
                                    width: '32px',
                                    height: '32px',
                                    background: 'radial-gradient(circle, #00ff88, #00aa55)',
                                    borderRadius: '50%',
                                    position: 'relative',
                                    boxShadow: 'inset 0 0 8px rgba(0, 0, 0, 0.5)'
                                }}>
                                    <div style={{
                                        position: 'absolute',
                                        top: '50%',
                                        left: '50%',
                                        transform: 'translate(-50%, -50%)',
                                        width: '16px',
                                        height: '16px',
                                        background: 'linear-gradient(45deg, #ffffff, #cccccc)',
                                        borderRadius: '50%',
                                        boxShadow: '0 2px 4px rgba(0, 0, 0, 0.3)'
                                    }} />
                                </div>
                                {/* Ï°∞Ïù¥Ïä§Ìã± Í∑∏Î¶¨Îìú */}
                                <div style={{
                                    position: 'absolute',
                                    top: '3px',
                                    left: '3px',
                                    right: '3px',
                                    bottom: '3px',
                                    background: `
                                        linear-gradient(0deg, rgba(0, 255, 136, 0.15) 1px, transparent 1px),
                                        linear-gradient(90deg, rgba(0, 255, 136, 0.15) 1px, transparent 1px)
                                    `,
                                    backgroundSize: '8px 8px',
                                    borderRadius: '50%',
                                    pointerEvents: 'none'
                                }} />
                            </div>
                        </div>
                        
                        {/* Ïï°ÏÖò Î≤ÑÌäºÎì§ */}
                        <div style={{
                            display: 'flex',
                            gap: '12px',
                            alignItems: 'center'
                        }}>
                            <div style={{
                                width: '35px',
                                height: '35px',
                                borderRadius: '50%',
                                background: 'linear-gradient(145deg, #ff4444, #cc0000)',
                                border: '2px solid #ff6666',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#ffffff',
                                fontSize: '10px',
                                fontWeight: 'bold',
                                boxShadow: '0 0 12px rgba(255, 68, 68, 0.5)',
                                cursor: 'pointer',
                                transition: 'all 0.3s ease'
                            }}
                            onMouseOver={(e) => {
                                e.currentTarget.style.transform = 'scale(1.1)';
                                e.currentTarget.style.boxShadow = '0 0 20px rgba(255, 68, 68, 0.8)';
                            }}
                            onMouseOut={(e) => {
                                e.currentTarget.style.transform = 'scale(1)';
                                e.currentTarget.style.boxShadow = '0 0 12px rgba(255, 68, 68, 0.5)';
                            }}
                            >
                                A
                            </div>
                            <div style={{
                                width: '30px',
                                height: '30px',
                                borderRadius: '50%',
                                background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                                border: '2px solid #555',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#ffffff',
                                fontSize: '9px',
                                fontWeight: 'bold',
                                boxShadow: '0 0 8px rgba(0, 0, 0, 0.3)'
                            }}>
                                B
                            </div>
                            <div style={{
                                width: '45px',
                                height: '22px',
                                borderRadius: '11px',
                                background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                                border: '2px solid #555',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#ffffff',
                                fontSize: '7px',
                                fontWeight: 'bold',
                                boxShadow: '0 0 8px rgba(0, 0, 0, 0.3)'
                            }}>
                                START
                            </div>
                            <div style={{
                                width: '30px',
                                height: '30px',
                                borderRadius: '50%',
                                background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                                border: '2px solid #555',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#ffffff',
                                fontSize: '9px',
                                fontWeight: 'bold',
                                boxShadow: '0 0 8px rgba(0, 0, 0, 0.3)'
                            }}>
                                X
                            </div>
                            <div style={{
                                width: '30px',
                                height: '30px',
                                borderRadius: '50%',
                                background: 'linear-gradient(145deg, #2a2a2a, #1a1a1a)',
                                border: '2px solid #555',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#ffffff',
                                fontSize: '9px',
                                fontWeight: 'bold',
                                boxShadow: '0 0 8px rgba(0, 0, 0, 0.3)'
                            }}>
                                Y
                            </div>
          </div>
        </div>
      </div>

            {/* Í≤åÏûÑ ÏãúÏûë ÌôïÏù∏ Î™®Îã¨ */}
            <GameStartModal
                isOpen={showStartModal}
                onClose={() => setShowStartModal(false)}
                onStartGame={handleStartGame}
            />

            {/* Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ Î™®Îã¨ */}
            <GamePauseModal
                isOpen={showPauseModal}
                onClose={() => setShowPauseModal(false)}
                onResume={handleResume}
                onExit={handleExit}
            />


            {/* Í≤åÏûÑ Ï¢ÖÎ£å ÌôïÏù∏ Î™®Îã¨ */}
            <GameExitModal
                isOpen={showExitModal}
                onClose={() => setShowExitModal(false)}
                onConfirmExit={handleExitConfirm}
                onCancel={handleExitCancel}
            />

            {/* ÏùåÏó≠ÎåÄ Í≤∞Í≥º Î™®Îã¨ */}
            <VoiceRangeResultModal
                isOpen={showVoiceRangeResult}
                onClose={handleVoiceRangeResultClose}
                onContinue={handleVoiceRangeResultContinue}
                highestNote={voiceRangeData.highestNote}
                lowestNote={voiceRangeData.lowestNote}
                highestFrequency={voiceRangeData.highestFrequency}
                lowestFrequency={voiceRangeData.lowestFrequency}
            />
    </div>
        </>
  );
};

export default VoiceTestGame;